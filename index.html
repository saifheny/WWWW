<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>منصة الاختبارات الذكية 🚀</title>
    <!-- Meta Tags -->
    <meta property="og:title" content="منصة الاختبارات الذكية 🚀" />
    <meta property="og:description" content="بوابة التعلم الذكي التي تدمج التكنولوجيا بالتعليم!" />
    <meta property="og:image" content="https://i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png" />
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="الاختبارات الذكية">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/3RBYLnd3/818334fa-20ba-431a-ad38-6bec7ef02203.png">
    <meta name="theme-color" content="#000000">
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- General & Base Styles --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            direction: rtl;
            text-align: center;
            overflow-x: hidden;
        }
        .hidden { display: none !important; }

        /* --- Landing Page Styles --- */
        #main-landing-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 40px 20px;
            background: #000;
        }
        #main-landing-page .supervision-tag {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: rgba(0, 123, 255, 0.1); backdrop-filter: blur(10px);
            padding: 12px 25px; border-radius: 50px; font-size: 1rem; font-weight: 700;
            color: #00aaff; border: 1px solid rgba(0, 123, 255, 0.5);
            box-shadow: 0 4px 20px rgba(0, 123, 255, 0.2); animation: floating 6s ease-in-out infinite;
        }
        #main-landing-page h1 {
            font-size: 4rem;
            background: linear-gradient(45deg, #007BFF 30%, #00C6FF 70%);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 30px; font-weight: 800; line-height: 1.2;
            text-shadow: 0 0 15px rgba(0, 123, 255, 0.5), 0 0 30px rgba(0, 123, 255, 0.3);
        }
        #main-landing-page p { font-size: 1.2rem; color: #ccc; line-height: 1.8; margin-bottom: 35px; max-width: 800px; }
        #main-landing-page .features {
            list-style: none; padding: 0; margin: 40px 0; display: flex;
            flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 900px;
        }
        #main-landing-page .features li {
            background: #111; padding: 20px; border-radius: 16px;
            border: 1px solid #222; transition: all 0.3s ease; display: flex; align-items: center;
            font-size: 1.1rem; font-weight: 600; flex-basis: 200px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        #main-landing-page .features li:hover { transform: translateY(-5px); box-shadow: 0 8px 24px rgba(0, 123, 255, 0.2); }
        #main-landing-page .features li i { color: #00aaff; margin-left: 12px; font-size: 1.4rem; }
        #main-landing-page .role-selection { display: flex; flex-direction: column; gap: 25px; margin-top: 40px; width:100%; max-width: 400px; }

        /* --- 3D Button Style --- */
        .btn-3d {
            padding: 20px 40px; border: none; border-radius: 12px;
            font-size: 1.5rem; font-family: 'Cairo', sans-serif; font-weight: 800; color: #fff;
            cursor: pointer; position: relative;
            background: linear-gradient(180deg, #00A6F3 0%, #0072D3 100%);
            border-bottom: 6px solid #00529A;
            text-shadow: 0px 2px 3px rgba(0, 0, 0, 0.4);
            box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.1s ease-in-out;
            text-decoration: none; display: flex; align-items: center; justify-content: center;
        }
        .btn-3d i { margin-left: 15px; font-size: 1.8rem; }
        .btn-3d:hover { transform: translateY(-4px); box-shadow: 0px 12px 20px rgba(0, 0, 0, 0.4); border-bottom-width: 8px; }
        .btn-3d:active { transform: translateY(2px); box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.4); border-bottom-width: 4px; }
        
        /* --- General Portal Styles --- */
        .portal-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; animation: fadeIn 0.6s ease-out; color: #eee;
            overflow-y: auto; padding: 40px 20px 120px 20px;
        }
        .portal-content { max-width: 600px; margin: 0 auto; }
        .portal-container .icon-btn {
            width: 40px; height: 40px; border-radius: 50%; background: #1a1a1a;
            border: 1px solid #333; color: #eee; display: flex; align-items: center;
            justify-content: center; cursor: pointer; font-size: 18px; transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); position: relative;
        }
        .portal-container .icon-btn .notification-badge {
            position: absolute; top: -5px; right: -5px;
            width: 20px; height: 20px; background-color: #dc3545;
            border-radius: 50%; font-size: 12px; line-height: 20px;
            font-weight: bold; display: none;
        }
        .portal-container .icon-btn:hover { transform: translateY(-3px); color: #00aaff; box-shadow: 0 0 15px rgba(0, 170, 255, 0.5); }
        .portal-container .spinner { border: 4px solid #333; border-top: 4px solid #00aaff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        .portal-container p { text-align: center; margin-top: 15px; font-size: 0.9rem; color: #aaa; }
        .portal-container p a { color: #00aaff; text-decoration: none; font-weight: 600; }
        .portal-container hr { border: none; border-top: 1px solid #333; margin: 25px 0; }
        .portal-container button { width: 100%; padding: 14px 15px; border: none; border-radius: 12px; font-size: 1.1rem; font-family: 'Cairo', sans-serif; font-weight: 700; color: #fff; cursor: pointer; transition: all 0.2s ease; }
        .portal-container button:disabled { cursor: not-allowed; background: #555; border-bottom-color: #333; opacity: 0.6; }
        .portal-container .btn-primary { background: linear-gradient(180deg, #00A6F3 0%, #0072D3 100%); border-bottom: 4px solid #00529A; }
        .portal-container .btn-primary:not(:disabled):hover { transform: translateY(-2px); border-bottom-width: 6px; }
        .portal-container .btn-primary:not(:disabled):active { transform: translateY(1px); border-bottom-width: 3px; }
        .portal-container .btn-secondary { background: #2a2a2a; border-bottom: 4px solid #111; }
        .portal-container .btn-secondary:not(:disabled):hover { transform: translateY(-2px); border-bottom-width: 6px; }
        .portal-container .btn-secondary:not(:disabled):active { transform: translateY(1px); border-bottom-width: 3px; }
        
        .bottom-nav {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: auto; display: flex;
            gap: 8px; padding: 8px; background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(20px);
            border-radius: 99px; border: 1px solid #333; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.7); z-index: 1000;
        }
        .bottom-nav .nav-btn { display: flex; align-items: center; gap: 5px; padding: 8px 16px; background: transparent; border: none; color: #aaa; opacity: 0.7; border-radius: 99px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .bottom-nav .nav-btn.active { opacity: 1; background: rgba(0, 170, 255, 0.15); color: #00aaff; box-shadow: 0 0 15px -5px rgba(0, 170, 255, 0.5); }

        /* --- 3D Inputs & Items --- */
        input, select, textarea {
            background: #111; color: #eee; border: 1px solid #333;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            border-radius: 10px; padding: 14px 15px; width: 100%;
            margin-bottom: 15px; font-size: 1rem; font-family: 'Cairo', sans-serif;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #00aaff; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 10px rgba(0, 170, 255, 0.5); }
        .list-item, .test-item, .question-options label {
            background: #1a1a1a; padding: 15px; margin-bottom: 12px;
            border-radius: 12px; border: 1px solid #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease; display: flex; align-items: center;
        }
        .list-item:hover, .test-item:hover { transform: translateY(-3px) scale(1.02); border-color: #00aaff; box-shadow: 0 8px 20px rgba(0, 170, 255, 0.2); }
        
        /* --- Teacher Portal Specifics --- */
        #teacher-portal h1, #teacher-portal h2 { color: #00aaff; text-shadow: 0 0 10px rgba(0, 170, 255, 0.5); }
        #teacher-portal .header-icons { position: absolute; top: 40px; left: 25px; display: flex; gap: 10px; z-index: 100; }
        #teacher-portal label { font-weight: 600; display: block; margin-bottom: 5px; text-align: right; }
        .file-input-label { background: #222; border: 1px dashed #444; text-align: center; padding: 15px; border-radius: 10px; cursor: pointer; transition: all .3s ease; display: block; margin-bottom: 15px; }
        .image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #444; cursor: pointer; }
        .action-btn { padding: 6px 10px !important; font-size: 0.8rem !important; margin:0 !important; width: auto !important; display: flex; align-items: center; gap: 5px; }

        /* --- Generic Modal --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: #111; border: 1px solid #333; width: 95%; max-width: 700px;
            max-height: 90vh; padding: 25px; border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); overflow-y: auto;
            position: relative; display: flex; flex-direction: column;
        }
        .modal-close-btn {
            position: absolute; top: 10px; left: 10px;
            width: 35px; height: 35px;
            background: rgba(255,255,255,0.1); color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            font-size: 20px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
            line-height: 1; z-index: 10;
        }
        .modal-close-btn:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
        .modal-body { flex-grow: 1; overflow-y: auto; }
        .modal-footer { margin-top: 20px; flex-shrink: 0; }
        
        /* --- Image Viewer Modal --- */
        .image-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease;
        }
        .image-modal-overlay.visible { opacity: 1; visibility: visible; }
        .image-modal-content { max-width: 90vw; max-height: 80vh; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); cursor: default; }
        .image-modal-download-btn {
            position: absolute; top: 20px;
            width: 45px; height: 45px;
            background: rgba(40, 40, 40, 0.8);
            color: #fff; border: none; border-radius: 50%;
            font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            text-decoration: none;
            transition: transform 0.2s ease;
            right: 20px; 
        }
        .image-modal-download-btn:hover { transform: scale(1.1); }

        /* --- Custom Alert/Confirm Modals --- */
        .custom-dialog-overlay { position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,.7); backdrop-filter: blur(5px); opacity:0; visibility:hidden; transition:opacity .3s; z-index:9999; }
        .custom-dialog-overlay.show { opacity:1; visibility:visible; }
        .custom-dialog { background:#1a1a1a; border: 1px solid #333; border-radius: 16px; padding:25px 30px; margin: 20px; width: 90%; max-width:400px; text-align:center; box-shadow:0 8px 25px rgba(0,0,0,0.7); transform:scale(0.9); opacity:0; transition:transform .3s,opacity .3s; }
        .custom-dialog-overlay.show .custom-dialog { transform:scale(1); opacity:1; }
        .custom-dialog h3 { color: #00aaff; margin-bottom: 10px; font-size: 1.5rem; }
        .custom-dialog p { margin: 15px 0; color: #ccc; line-height: 1.6; }
        .custom-dialog .dialog-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        
        .custom-dialog .dialog-buttons button {
            min-width: 100px; width: auto; padding: 12px 25px !important;
            border-radius: 10px !important; font-size: 1rem !important;
            font-weight: 700 !important; border-bottom-width: 4px !important;
            text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.4);
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.1s ease-in-out !important; transform: translateY(0);
        }
        .custom-dialog .dialog-buttons button:hover {
            transform: translateY(-2px); box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.4);
            border-bottom-width: 5px !important;
        }
        .custom-dialog .dialog-buttons button:active {
            transform: translateY(1px); box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.4);
            border-bottom-width: 3px !important;
        }
        .custom-dialog .dialog-buttons .btn-primary { background: linear-gradient(180deg, #00A6F3 0%, #0072D3 100%); border-bottom-color: #00529A; }
        .custom-dialog .dialog-buttons .btn-secondary { background: #5a6268; border-bottom-color: #495057; }
        
        /* Chat Modal */
        #chat-modal .chat-body { display: flex; flex-direction: column; gap: 15px; padding: 10px; max-height: 50vh; overflow-y: auto;}
        .chat-message { max-width: 75%; padding: 10px; border-radius: 12px; display: flex; flex-direction: column; }
        .chat-message.sent { background: #007bff; align-self: flex-end; text-align: left; }
        .chat-message.received { background: #333; align-self: flex-start; text-align: right; }
        .chat-message audio { margin-top: 5px; }
        .chat-message .msg-time { font-size: 0.75rem; color: #ddd; margin-top: 5px; opacity: 0.8;}
        #record-voice-btn.recording { background: #dc3545; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }


        /* Animations & Responsiveness */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 767px) {
            #main-landing-page h1 { font-size: 2.8rem; }
            #main-landing-page .supervision-tag { display: none; }
            .btn-3d { font-size: 1.2rem; padding: 18px 30px; }
        }
    </style>
</head>
<body>
    <!-- ======== Main Landing Page Section ======== -->
    <main id="main-landing-page">
        <div class="supervision-tag"><i class="fas fa-star"></i> تحت إشراف: سيف هاني <i class="fas fa-star"></i></div>
        <h1>منصة الاختبارات الذكية 🚀</h1>
        <p>بوابة التعلم الذكي التي تدمج التكنولوجيا بالتعليم! 🌟 سواء كنت <strong>معلمًا</strong> مبتكرًا أو <strong>طالبًا</strong> طموحًا، نقدم لك أدوات متكاملة لتحقيق التميز الأكاديمي!</p>
        <ul class="features">
            <li><i class="fas fa-magic"></i>إنشاء اختبارات ذكية</li>
            <li><i class="fas fa-chart-line"></i>تحليلات أداء متقدمة</li>
            <li><i class="fas fa-clock"></i>تصحيح آلي فوري</li>
            <li><i class="fas fa-shield-alt"></i>نظام أمان متكامل</li>
        </ul>
        <div class="role-selection">
            <a href="#" id="show-teacher-portal" class="btn-3d">دخول المعلمين <i class="fas fa-chalkboard-teacher"></i></a>
            <a href="#" id="show-student-portal" class="btn-3d">دخول الطلاب <i class="fas fa-user-graduate"></i></a>
        </div>
    </main>

    <!-- ======== Teacher Portal Section (Initially Hidden) ======== -->
    <div id="teacher-portal" class="portal-container hidden">
        <div class="portal-content">
            <div class="header-icons">
                <div id="teacher-chat-notification" class="icon-btn hidden" title="الرسائل"><i class="fas fa-comments"></i><span class="notification-badge"></span></div>
                <div id="teacher-profile-icon" class="icon-btn hidden" title="الملف الشخصي"><i class="fas fa-user-edit"></i></div>
                <div id="teacher-logout-icon" class="icon-btn hidden" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></div>
            </div>
            <!-- Sections go here -->
            <section id="teacher-register-section">
                <h1>تسجيل جديد - معلم</h1>
                <input type="text" id="teacher-register-name" placeholder="الاسم الكامل (باللغة الإنجليزية)" required />
                <input type="password" id="teacher-register-password" placeholder="كلمة المرور" required />
                <button id="teacher-register-btn" class="btn-primary">تسجيل</button>
                <p>هل لديك حساب؟ <a href="#" class="to-login">تسجيل دخول</a></p>
            </section>
            <section id="teacher-login-section" class="hidden">
                <h1>تسجيل دخول - معلم</h1>
                <input type="text" id="teacher-login-name" placeholder="الاسم الكامل (باللغة الإنجليزية)" required />
                <input type="password" id="teacher-login-password" placeholder="كلمة المرور" required />
                <button id="teacher-login-btn" class="btn-primary">دخول</button>
                <p>ليس لديك حساب؟ <a href="#" class="to-register">تسجيل جديد</a></p>
            </section>
            <section id="teacher-dashboard-section" class="hidden">
                <h1>مرحبًا بك، <span id="teacher-name"></span>!</h1><hr />
                <div id="teacher-tests-content" class="tab-content"><h2>اختباراتي المنشأة</h2><div id="my-tests-container"></div></div>
                <div id="teacher-results-content" class="tab-content hidden"><h2>نتائج الطلاب</h2><select id="results-test-selector"></select><div id="student-results-container"></div></div>
                <div id="teacher-create-test-content" class="tab-content hidden">
                    <h2 id="create-edit-title">إنشاء اختبار جديد</h2>
                    <label for="test-name">اسم الاختبار:</label><input type="text" id="test-name" />
                    <label for="test-grade">الصف:</label>
                    <select id="test-grade"><option value="" disabled selected>اختر الصف</option><option value="الصف الأول الإعدادي">الصف الأول الإعدادي</option><option value="الصف الثاني الإعدادي">الصف الثاني الإعدادي</option><option value="الصف الثالث الإعدادي">الصف الثالث الإعدادي</option><option value="الصف الأول الثانوي">الصف الأول الثانوي</option><option value="الصف الثاني الثانوي">الصف الثاني الثانوي</option><option value="الصف الثالث الثانوي">الصف الثالث الثانوي</option></select>
                    <label for="test-duration">مدة الاختبار بالدقائق:</label><input type="number" id="test-duration" min="1" />
                    <div class="list-item" style="flex-direction: row; justify-content: flex-start; gap: 10px; cursor: pointer;" onclick="this.querySelector('input').click()"><input type="checkbox" id="prevent-go-back-checkbox" style="width: auto; margin: 0;"><label for="prevent-go-back-checkbox" style="margin: 0;">منع الطالب من الرجوع للخلف</label></div>
                    <div class="list-item" style="flex-direction: row; justify-content: flex-start; gap: 10px; cursor: pointer;" onclick="this.querySelector('input').click()"><input type="checkbox" id="shuffle-questions-checkbox" style="width: auto; margin: 0;"><label for="shuffle-questions-checkbox" style="margin: 0;">ترتيب الأسئلة عشوائيًا</label></div>
                    <hr/><h3>إضافة سؤال جديد</h3>
                    <div style="display: flex; border: 1px solid #333; border-radius: 12px; overflow: hidden; margin-bottom: 15px;">
                        <button class="switch-button active" data-type="mcq" style="flex:1; padding:10px; background: #0072D3; border:none; color: #fff; cursor: pointer; transition: all 0.3s ease;">سؤال اختياري</button>
                        <button class="switch-button" data-type="essay" style="flex:1; padding:10px; background: #222; border:none; color: #fff; cursor: pointer; transition: all 0.3s ease;">سؤال مقالي</button>
                    </div>
                    <label for="question-text">نص السؤال:</label><textarea id="question-text" rows="3"></textarea>
                    <label for="question-image-input" class="file-input-label"><i class="fas fa-image"></i> <span>إرفاق صورة للسؤال (اختياري)</span></label>
                    <input type="file" id="question-image-input" accept="image/*" class="hidden" /><div class="image-preview-container hidden"><img class="image-preview" src="#" alt="معاينة" /></div>
                    <div id="mcq-fields">
                        <label>خيارات الإجابة (4):</label>
                        <input type="text" class="option-input" placeholder="الخيار 1" /><input type="text" class="option-input" placeholder="الخيار 2" /><input type="text" class="option-input" placeholder="الخيار 3" /><input type="text" class="option-input" placeholder="الخيار 4" />
                        <label for="correct-answer">رقم الإجابة الصحيحة (1 - 4):</label><input type="number" id="correct-answer" min="1" max="4" />
                    </div>
                    <div id="essay-fields" class="hidden">
                        <label for="model-answer-image-input" class="file-input-label"><i class="fas fa-file-image"></i> <span>إرفاق صورة إجابة نموذجية (اختياري)</span></label>
                        <input type="file" id="model-answer-image-input" accept="image/*" class="hidden"><div class="image-preview-container hidden"><img class="image-preview" src="#" alt="معاينة" /></div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                        <label for="question-points" style="margin: 0; flex-shrink: 0;">درجات السؤال:</label>
                        <input type="number" id="question-points" min="1" placeholder="1" style="margin: 0; width: 80px;">
                        <button id="add-question-btn" class="btn-secondary" style="margin: 0; flex-grow: 1;">إضافة سؤال للقائمة</button>
                        <button id="cancel-question-edit-btn" class="btn-secondary hidden" style="margin: 0; width: auto; background: #5a6268; border-color: #495057;">إلغاء التعديل</button>
                    </div>
                    <div id="questions-list-container" style="margin-top: 15px;"></div>
                    <button id="save-test-btn" class="btn-primary" style="margin-top: 20px; background: linear-gradient(180deg, #28a745 0%, #218838 100%); border-bottom-color: #1e7e34;">حفظ الاختبار</button>
                    <button id="cancel-test-edit-btn" class="btn-secondary hidden" style="margin-top: 10px;">إلغاء التعديل</button>
                </div>
            </section>
        </div>
        <!-- Teacher Modals -->
        <div id="teacher-review-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close-btn">&times;</button>
                <h2 id="review-modal-title">مراجعة إجابات الطالب</h2>
                <div id="review-modal-body" class="modal-body"></div>
                <div id="review-modal-footer" class="modal-footer hidden">
                    <button id="finalize-grades-btn" class="btn-primary">حفظ الدرجات النهائية</button>
                </div>
            </div>
        </div>
        <div id="teacher-profile-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 450px;">
                <button class="modal-close-btn">&times;</button>
                <h2>تعديل الملف الشخصي</h2>
                <label for="teacher-update-name">الاسم (باللغة الإنجليزية):</label>
                <input type="text" id="teacher-update-name" placeholder="الاسم الكامل الجديد">
                <label for="teacher-update-password">كلمة المرور الجديدة:</label>
                <input type="password" id="teacher-update-password" placeholder="اتركها فارغة لعدم التغيير">
                <button id="teacher-update-btn" class="btn-primary">تحديث الحساب</button>
            </div>
        </div>
        <nav class="bottom-nav hidden" id="teacher-bottom-nav">
            <button class="nav-btn active" data-target="teacher-tests-content"><i class="fas fa-file-alt"></i><span>الاختبارات</span></button>
            <button class="nav-btn" data-target="teacher-results-content"><i class="fas fa-poll-h"></i><span>النتائج</span></button>
            <button class="nav-btn" data-target="teacher-create-test-content"><i class="fas fa-plus-circle"></i><span>إنشاء</span></button>
        </nav>
    </div>

    <!-- ======== Student Portal Section (Initially Hidden) ======== -->
    <div id="student-portal" class="portal-container hidden">
         <div class="portal-content">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1 style="font-size:1.8rem; margin:0;"><i class="fas fa-graduation-cap"></i> منصة الاختبارات</h1>
                <div class="header-icons" style="position: static; display: flex; gap: 10px;">
                    <div id="student-chat-notification" class="icon-btn hidden" title="الرسائل"><i class="fas fa-comments"></i><span class="notification-badge"></span></div>
                    <div id="student-profile-icon" class="icon-btn hidden" title="الملف الشخصي"><i class="fas fa-user-edit"></i></div>
                    <div id="student-logout-icon" class="icon-btn hidden" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></div>
                </div>
            </div>
            
            <section id="student-register-section">
                <h2>تسجيل جديد</h2>
                <input type="text" id="student-register-name" placeholder="الاسم الكامل (باللغة الإنجليزية)" required autocomplete="off">
                <input type="password" id="student-register-password" placeholder="كلمة المرور" required autocomplete="new-password">
                <button id="student-register-btn" class="btn-primary">تسجيل</button><p>هل لديك حساب؟ <a href="#" class="to-login">تسجيل دخول</a></p>
            </section>
            <section id="student-login-section" class="hidden">
                <h2>تسجيل الدخول</h2>
                <input type="text" id="student-login-name" placeholder="الاسم الكامل (باللغة الإنجليزية)" required autocomplete="off">
                <input type="password" id="student-login-password" placeholder="كلمة المرور" required autocomplete="current-password">
                <button id="student-login-btn" class="btn-primary">دخول</button><p>ليس لديك حساب؟ <a href="#" class="to-register">تسجيل جديد</a></p>
            </section>
            <section id="student-dashboard-section" class="hidden">
                <h1>مرحبًا بك، <span id="student-name"></span>!</h1><hr />
                <div class="tab-content" id="student-tests-content">
                    <input type="text" id="search-bar" placeholder="ابحث عن اختبار..." style="margin-bottom:20px;"/>
                    <h2>الاختبارات المتاحة</h2><div id="available-tests-container"></div>
                </div>
                <div class="tab-content hidden" id="student-results-content"><h2>نتائجي السابقة</h2><div id="my-student-results-container"></div></div>
            </section>
            <section id="take-test-section" class="hidden">
                <h2 id="current-test-title"></h2>
                <div id="timer" style="font-size:1.6rem; font-weight:700; color:#ffc107; margin-bottom:8px;"></div>
                <div style="width:100%; height:6px; background:#222; border-radius:3px; overflow:hidden; margin-bottom:20px;"><div id="timer-progress" style="height:100%; width:100%; background:#007bff; transition:width .5s linear;"></div></div>
                <div id="questions-display"></div>
                <div id="question-navigation-container" style="display:flex; gap:10px; margin-top: 20px;" class="hidden">
                    <button id="prev-question-btn" class="btn-secondary">السابق</button>
                    <button id="next-question-btn" class="btn-primary">التالي</button>
                </div>
                <button id="submit-test-btn" class="btn-primary" style="margin-top: 20px; background: linear-gradient(180deg, #28a745 0%, #218838 100%); border-bottom-color: #1e7e34;">تسليم الاختبار</button>
                <button id="cancel-test-btn" class="btn-secondary" style="margin-top: 10px;">إلغاء الاختبار</button>
            </section>
            <section id="test-result-section" class="hidden">
                <h1>نتيجتك</h1>
                <h2 id="final-score" style="font-size:2rem; margin:15px 0;"></h2>
                <div id="feedback-message" style="padding:15px; border-radius:12px; margin-top:15px; font-weight:600; font-size: 1.1rem;"></div>
                <button id="review-answers-btn" class="btn-primary">مراجعة الإجابات</button>
                <button id="back-to-dashboard-btn" class="btn-secondary" style="margin-top: 10px;">العودة للرئيسية</button>
            </section>
            <section id="review-section" class="hidden">
                <h1>مراجعة الإجابات</h1>
                <div id="review-container"></div>
                <button id="back-to-results-btn" class="btn-secondary" style="margin-top: 10px;">العودة للنتيجة</button>
            </section>
         </div>
         <!-- Student Modals -->
         <div id="student-profile-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 450px;">
                <button class="modal-close-btn">&times;</button>
                <h2>تعديل الملف الشخصي</h2>
                <label for="student-update-name">الاسم (باللغة الإنجليزية):</label>
                <input type="text" id="student-update-name" placeholder="الاسم الكامل الجديد">
                <label for="student-update-password">كلمة المرور الجديدة:</label>
                <input type="password" id="student-update-password" placeholder="اتركها فارغة لعدم التغيير">
                <button id="student-update-btn" class="btn-primary">تحديث الحساب</button>
            </div>
        </div>
         <nav class="bottom-nav hidden" id="student-bottom-nav">
            <button class="nav-btn active" data-target="student-tests-content"><i class="fas fa-book-open"></i><span>الاختبارات</span></button>
            <button class="nav-btn" data-target="student-results-content"><i class="fas fa-poll-h"></i><span>نتائجي</span></button>
        </nav>
    </div>
    
    <!-- ======== Universal Modals ======== -->
    <div id="image-viewer-modal" class="image-modal-overlay">
        <button class="modal-close-btn">&times;</button>
        <a href="#" class="image-modal-download-btn" download="image.jpg"><i class="fas fa-download"></i></a>
        <img src="" alt="Image Preview" class="image-modal-content">
    </div>

    <div id="chat-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close-btn">&times;</button>
            <h2 id="chat-modal-title">محادثة مع</h2>
            <div class="chat-body" id="chat-modal-body"></div>
            <div class="modal-footer">
                <button id="record-voice-btn" class="btn-primary"><i class="fas fa-microphone"></i> تسجيل رسالة صوتية</button>
            </div>
        </div>
    </div>

    <!-- ======== Custom Dialogs (Alerts/Confirms) ======== -->
    <div id="custom-alert-container" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <h3 id="custom-alert-title"></h3>
            <p id="custom-alert-message"></p>
            <div class="dialog-buttons">
                <button id="custom-alert-close-btn" class="btn-primary">موافق</button>
            </div>
        </div>
    </div>
    <div id="custom-confirm-container" class="custom-dialog-overlay">
        <div class="custom-dialog">
            <h3 id="custom-confirm-title"></h3>
            <p id="custom-confirm-message"></p>
            <div class="dialog-buttons">
                <button id="custom-confirm-cancel-btn" class="btn-secondary">إلغاء</button>
                <button id="custom-confirm-ok-btn" class="btn-primary">تأكيد</button>
            </div>
        </div>
    </div>


    <!-- ======== Main JavaScript Logic ======== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        import { getDatabase, ref, set, get, onValue, push, serverTimestamp, remove, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDb19zrwV84CCbI8s2q8utFdIhasokmrpQ",
            authDomain: "saif-28e78.firebaseapp.com",
            databaseURL: "https://saif-28e78-default-rtdb.firebaseio.com",
            projectId: "saif-28e78",
            storageBucket: "saif-28e78.appspot.com",
            messagingSenderId: "979905571539",
            appId: "1:979905571539:web:3ff28289e17d3180964226",
            measurementId: "G-47JV5KDDTP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        const mainLandingPage = document.getElementById('main-landing-page');
        const teacherPortal = document.getElementById('teacher-portal');
        const studentPortal = document.getElementById('student-portal');
        
        document.getElementById('show-teacher-portal').addEventListener('click', (e) => { e.preventDefault(); mainLandingPage.classList.add('hidden'); teacherPortal.classList.remove('hidden'); initTeacherApp(); });
        document.getElementById('show-student-portal').addEventListener('click', (e) => { e.preventDefault(); mainLandingPage.classList.add('hidden'); studentPortal.classList.remove('hidden'); initStudentApp(); });
        
        const handleDeepLink = () => { const h=window.location.hash; if(h.startsWith('#test/')){const p=h.split('/');if(p.length===3){sessionStorage.setItem('deepLinkTest',JSON.stringify({teacherId:decodeURIComponent(p[1]),testId:decodeURIComponent(p[2])}));mainLandingPage.classList.add('hidden');studentPortal.classList.remove('hidden');initStudentApp();return true}}return false };
        const getBase64 = (file) => new Promise((resolve, reject) => { const reader=new FileReader();reader.readAsDataURL(file);reader.onload=()=>resolve(reader.result);reader.onerror=e=>reject(e) });
        
        // --- Custom Dialog Functions ---
        const alertCont = document.getElementById('custom-alert-container');
        const confirmCont = document.getElementById('custom-confirm-container');

        const showCustomAlert = (title, message) => {
            alertCont.querySelector('#custom-alert-title').textContent = title;
            alertCont.querySelector('#custom-alert-message').textContent = message;
            alertCont.classList.add('show');
        };
        alertCont.querySelector('#custom-alert-close-btn').onclick = () => alertCont.classList.remove('show');

        const showCustomConfirm = (title, message) => {
            return new Promise(resolve => {
                confirmCont.querySelector('#custom-confirm-title').textContent = title;
                confirmCont.querySelector('#custom-confirm-message').textContent = message;
                confirmCont.classList.add('show');

                const okBtn = confirmCont.querySelector('#custom-confirm-ok-btn');
                const cancelBtn = confirmCont.querySelector('#custom-confirm-cancel-btn');

                const cleanup = (result) => {
                    confirmCont.classList.remove('show');
                    // Important: Re-clone the button to remove the event listener for next time
                    okBtn.replaceWith(okBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                    resolve(result);
                };

                okBtn.addEventListener('click', () => cleanup(true), { once: true });
                cancelBtn.addEventListener('click', () => cleanup(false), { once: true });
            });
        };


        function initTeacherApp() {
            const allSections = teacherPortal.querySelectorAll('section');
            const dashboardSection = teacherPortal.querySelector('#teacher-dashboard-section');
            const loginSection = teacherPortal.querySelector('#teacher-login-section');
            const registerSection = teacherPortal.querySelector('#teacher-register-section');
            const createTestSection = teacherPortal.querySelector('#teacher-create-test-content');
            const logoutIcon = teacherPortal.querySelector('#teacher-logout-icon');
            const profileIcon = teacherPortal.querySelector('#teacher-profile-icon');
            const teacherNameSpan = teacherPortal.querySelector("#teacher-name");
            const bottomNav = teacherPortal.querySelector('#teacher-bottom-nav');
            const myTestsContainer = teacherPortal.querySelector("#my-tests-container");
            const resultsTestSelector = teacherPortal.querySelector("#results-test-selector");
            const studentResultsContainer = teacherPortal.querySelector("#student-results-container");
            const testNameInput = teacherPortal.querySelector("#test-name");
            const testGradeSelect = teacherPortal.querySelector("#test-grade");
            const testDurationInput = teacherPortal.querySelector("#test-duration");
            const preventGoBackCheckbox = teacherPortal.querySelector("#prevent-go-back-checkbox");
            const shuffleQuestionsCheckbox = teacherPortal.querySelector('#shuffle-questions-checkbox');
            const questionText = teacherPortal.querySelector("#question-text");
            const optionInputs = teacherPortal.querySelectorAll(".option-input");
            const correctAnswerInput = teacherPortal.querySelector("#correct-answer");
            const questionPointsInput = teacherPortal.querySelector("#question-points");
            const questionsListContainer = teacherPortal.querySelector("#questions-list-container");
            const questionImageInput = teacherPortal.querySelector("#question-image-input");
            const modelAnswerImageInput = teacherPortal.querySelector("#model-answer-image-input");
            const addQuestionBtn = teacherPortal.querySelector('#add-question-btn');
            const cancelQuestionEditBtn = teacherPortal.querySelector('#cancel-question-edit-btn');
            const saveTestBtn = teacherPortal.querySelector('#save-test-btn');
            const cancelTestEditBtn = teacherPortal.querySelector('#cancel-test-edit-btn');
            
            const reviewModal = teacherPortal.querySelector('#teacher-review-modal');
            const reviewModalBody = teacherPortal.querySelector('#review-modal-body');
            const reviewModalTitle = teacherPortal.querySelector('#review-modal-title');
            const reviewModalFooter = teacherPortal.querySelector('#review-modal-footer');
            const finalizeGradesBtn = teacherPortal.querySelector('#finalize-grades-btn');
            const profileModal = teacherPortal.querySelector('#teacher-profile-modal');
            const updateNameInput = teacherPortal.querySelector('#teacher-update-name');
            const updatePasswordInput = teacherPortal.querySelector('#teacher-update-password');
            const updateBtn = teacherPortal.querySelector('#teacher-update-btn');

            let currentUser = null, myTests = {}, questionsArray = [], currentQuestionImageBase64 = null, currentModelAnswerImageBase64 = null, currentQuestionType = 'mcq', currentEditingTestId = null, currentEditingQuestionIndex = -1;
            
            const showSection = (section) => { allSections.forEach(s=>s.classList.add('hidden')); section.classList.remove('hidden'); bottomNav.classList.toggle('hidden', section.id !== 'teacher-dashboard-section'); };
            const showLoadingSpinner = (container) => { container.innerHTML = `<div class="spinner"></div>`; };
            const navButtons = teacherPortal.querySelectorAll('.nav-btn');
            navButtons.forEach(button => { button.addEventListener('click', () => { navButtons.forEach(btn=>btn.classList.remove('active')); teacherPortal.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden')); button.classList.add('active'); teacherPortal.querySelector(`#${button.dataset.target}`).classList.remove('hidden'); if(button.dataset.target === 'teacher-create-test-content' && !currentEditingTestId) resetCreateFormState(); }); });
            const setDefaultTab = () => navButtons[0].click();
            
            const switchBtns = teacherPortal.querySelectorAll('.switch-button');
            switchBtns.forEach(btn => btn.addEventListener('click', () => {
                switchBtns.forEach(b => { b.classList.remove('active'); b.style.background = '#222'; });
                btn.classList.add('active'); btn.style.background = '#0072D3';
                currentQuestionType = btn.dataset.type;
                teacherPortal.querySelector("#mcq-fields").classList.toggle('hidden', currentQuestionType !== 'mcq');
                teacherPortal.querySelector("#essay-fields").classList.toggle('hidden', currentQuestionType !== 'essay');
            }));

            const clearQuestionForm = () => { questionText.value=""; questionImageInput.value=""; modelAnswerImageInput.value=""; currentQuestionImageBase64=null; currentModelAnswerImageBase64=null; teacherPortal.querySelectorAll('.image-preview-container').forEach(c=>c.classList.add('hidden')); teacherPortal.querySelectorAll('.image-preview').forEach(i=>i.src='#'); optionInputs.forEach(i=>i.value=""); correctAnswerInput.value=""; questionPointsInput.value = ""; currentEditingQuestionIndex = -1; addQuestionBtn.textContent = 'إضافة سؤال للقائمة'; cancelQuestionEditBtn.classList.add('hidden'); };
            
            async function updateDashboard() { if(!currentUser) return; teacherNameSpan.textContent = currentUser; logoutIcon.classList.remove('hidden'); profileIcon.classList.remove('hidden'); setDefaultTab(); showLoadingSpinner(myTestsContainer); const testsRef = ref(db, `tests/${currentUser}`); onValue(testsRef, (snapshot) => { myTests = snapshot.exists() ? snapshot.val() : {}; renderMyTests(); populateResultsSelector(); }); }
            
            function renderMyTests() {
                myTestsContainer.innerHTML = "";
                const tests = Object.entries(myTests).sort((a,b) => b[1].timestamp - a[1].timestamp);
                if (tests.length === 0) { myTestsContainer.innerHTML = "<p>لم تقم بإنشاء أي اختبارات نشطة.</p>"; return; }
                tests.forEach(([testId, test]) => {
                    const isExpired = Date.now() - test.timestamp > 48 * 60 * 60 * 1000;
                    const expiredClass = isExpired ? 'style="opacity: 0.5;"' : '';
                    const div = document.createElement('div'); div.className = 'list-item'; div.innerHTML = `<span style="flex-grow: 1; text-align: right;" ${expiredClass}>${test.name} - ${test.grade} ${isExpired ? '(منتهي)' : ''}</span>
                    <div style="display: flex; gap: 5px;">
                        <button class="action-btn btn-secondary" data-action="share" title="مشاركة"><i class="fas fa-share-alt"></i></button>
                        <button class="action-btn btn-secondary" data-action="results" title="النتائج"><i class="fas fa-poll-h"></i></button>
                        <button class="action-btn btn-secondary" data-action="edit" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-secondary" data-action="delete" title="حذف" style="background:#dc3545; border-color:#c82333;"><i class="fas fa-trash"></i></button>
                    </div>`;
                    div.querySelector('[data-action="share"]').onclick = () => copyTestLink(currentUser, testId);
                    div.querySelector('[data-action="results"]').onclick = () => { navButtons[1].click(); resultsTestSelector.value = testId; loadStudentResultsForTest(testId); };
                    div.querySelector('[data-action="edit"]').onclick = () => startEditingTest(testId, test);
                    div.querySelector('[data-action="delete"]').onclick = async () => {
                        const confirmed = await showCustomConfirm("تأكيد الحذف", "هل أنت متأكد من حذف هذا الاختبار نهائيًا؟ سيتم حذف جميع نتائج الطلاب المرتبطة به.");
                        if (confirmed) deleteTest(testId);
                    };
                    myTestsContainer.appendChild(div);
                });
            }

            async function deleteTest(testId) {
                try {
                    await remove(ref(db, `tests/${currentUser}/${testId}`));
                    await remove(ref(db, `results/${currentUser}/${testId}`));
                    showCustomAlert("نجاح", "تم حذف الاختبار بنجاح.");
                } catch (error) {
                    console.error("Error deleting test:", error);
                    showCustomAlert("خطأ", "حدث خطأ أثناء حذف الاختبار.");
                }
            }
            
            function startEditingTest(testId, testData) {
                navButtons[2].click();
                currentEditingTestId = testId;
                createTestSection.querySelector('#create-edit-title').textContent = "تعديل الاختبار";
                saveTestBtn.textContent = "تحديث الاختبار";
                cancelTestEditBtn.classList.remove('hidden');
                
                testNameInput.value = testData.name;
                testGradeSelect.value = testData.grade;
                testDurationInput.value = testData.duration;
                preventGoBackCheckbox.checked = testData.preventGoBack || false;
                shuffleQuestionsCheckbox.checked = testData.shuffle || false;
                questionsArray = [...(testData.questions || [])];
                renderQuestionsList();
            }

            function resetCreateFormState() {
                currentEditingTestId = null;
                createTestSection.querySelector('#create-edit-title').textContent = "إنشاء اختبار جديد";
                saveTestBtn.textContent = "حفظ الاختبار";
                cancelTestEditBtn.classList.add('hidden');
                testNameInput.value = ""; testGradeSelect.value = ""; testDurationInput.value = ""; preventGoBackCheckbox.checked=false; shuffleQuestionsCheckbox.checked=false;
                questionsArray = [];
                renderQuestionsList();
                clearQuestionForm();
            }
            cancelTestEditBtn.onclick = resetCreateFormState;

            async function loadStudentResultsForTest(testId) {
                if (!testId) { studentResultsContainer.innerHTML = ""; return; }
                showLoadingSpinner(studentResultsContainer);
                const snapshot = await get(ref(db, `results/${currentUser}/${testId}`));
                studentResultsContainer.innerHTML = "";
                if (!snapshot.exists()) { studentResultsContainer.innerHTML = "<p>لا توجد نتائج لهذا الاختبار بعد.</p>"; return; }
                const results = snapshot.val();
                Object.entries(results).forEach(([studentName, result]) => {
                    const div = document.createElement('div'); div.className = 'list-item';
                    const isPending = result.status === 'pending';
                    const pendingIndicator = isPending ? `<span style="color:#ffc107; font-weight:bold; margin-inline:10px;">(قيد المراجعة)</span>` : '';

                    div.innerHTML = `<span style="flex-grow:1; text-align: right;">الطالب: <strong>${studentName}</strong></span><span>الدرجة: <strong>${result.score}</strong></span>${pendingIndicator}<button class="action-btn btn-secondary" data-action="details" style="margin-right: 10px;">التفاصيل</button>`;
                    div.querySelector('[data-action="details"]').onclick = () => showStudentAnswerReview(studentName, testId, result);
                    studentResultsContainer.appendChild(div);
                });
            }

            function showStudentAnswerReview(studentName, testId, result) {
                const test = myTests[testId];
                const answers = result.answers;
                reviewModalTitle.textContent = `مراجعة إجابات: ${studentName}`;
                reviewModalBody.innerHTML = '';
                reviewModalFooter.classList.add('hidden');

                const hasEssays = test.questions.some(q => q.type === 'essay');
                if (result.status === 'pending' && hasEssays) {
                    reviewModalFooter.classList.remove('hidden');
                }

                test.questions.forEach((q, index) => {
                    const studentAnswer = answers[index] || {}; 
                    let reviewHtml = '';

                    if (q.type === 'mcq') {
                        const isCorrect = studentAnswer.answer === q.correct;
                        const score = isCorrect ? (q.points || 1) : 0;
                        reviewHtml = `<div style="background: ${isCorrect ? 'rgba(63,185,80,0.1)' : 'rgba(248,81,73,0.1)'}; padding: 10px; border-radius: 8px;"><b>إجابته:</b> ${studentAnswer.answer ? q.options[studentAnswer.answer - 1] : '<i>لم يجب</i>'}<br><b>الصحيحة:</b> ${q.options[q.correct - 1]}<br><b>الدرجة:</b> ${score}/${q.points || 1}</div>`;
                    } else { // Essay question
                        const studentText = studentAnswer.textAnswer || '<em>لم يقدم إجابة نصية.</em>';
                        const studentImage = studentAnswer.imageAnswer ? `<p><b>صورته:</b></p><img src="${studentAnswer.imageAnswer}" style="max-width:80%; border-radius:8px; cursor:pointer;">` : '';
                        const modelImage = q.modelAnswerImage ? `<p><b>النموذجية:</b></p><img src="${q.modelAnswerImage}" style="max-width:80%; border-radius:8px; cursor:pointer;">` : '';
                        
                        let gradingInput = '';
                        if (result.status === 'pending') {
                            gradingInput = `<div style="margin-top:15px; text-align: left; display:flex; align-items:center; gap:10px;">
                                <label for="grade-q-${index}" style="margin:0;"><b>ضع الدرجة:</b></label>
                                <input type="number" id="grade-q-${index}" data-question-index="${index}" class="essay-grade-input" min="0" max="${q.points || 1}" style="width:80px; margin:0;">
                                <span>/ ${q.points || 1}</span>
                            </div>`;
                        } else {
                            gradingInput = `<p><b>الدرجة النهائية للسؤال:</b> ${studentAnswer.pointsAwarded || 0}/${q.points || 1}</p>`;
                        }
                        
                        reviewHtml = `<div><p><b>إجابته النصية:</b></p><div style="background:#222; padding:10px; border-radius:8px; white-space: pre-wrap;">${studentText}</div>${studentImage}${modelImage}${gradingInput}</div>`;
                    }
                    const qDiv = document.createElement('div'); qDiv.className = 'list-item'; qDiv.style.flexDirection = 'column'; qDiv.style.alignItems = 'flex-start';
                    qDiv.innerHTML = `<h4 style="margin-bottom:10px;">س ${index+1} (${q.points || 1} درجات): ${q.question}</h4>${q.image ? `<img src="${q.image}" style="max-width:100%;border-radius:10px;margin:10px 0; cursor:pointer;">` : ''}${reviewHtml}`;
                    reviewModalBody.appendChild(qDiv);
                });
                
                finalizeGradesBtn.onclick = () => finalizeGrades(studentName, testId, test, result);
                reviewModal.classList.add('visible');
            }

            async function finalizeGrades(studentName, testId, test, originalResult) {
                let totalEssayScore = 0;
                let allGraded = true;
                const updatedAnswers = [...originalResult.answers];

                const gradeInputs = reviewModalBody.querySelectorAll('.essay-grade-input');
                gradeInputs.forEach(input => {
                    const questionIndex = parseInt(input.dataset.questionIndex);
                    const points = parseInt(input.value);
                    const maxPoints = test.questions[questionIndex].points || 1;

                    if (isNaN(points) || points < 0 || points > maxPoints) {
                        showCustomAlert("خطأ", `الرجاء إدخال درجة صحيحة للسؤال المقالي رقم ${questionIndex + 1}.`);
                        allGraded = false;
                        return;
                    }
                    totalEssayScore += points;
                    if(updatedAnswers[questionIndex]){
                        updatedAnswers[questionIndex].pointsAwarded = points;
                    } else { // In case student didn't answer at all
                        updatedAnswers[questionIndex] = {type: 'essay', pointsAwarded: points};
                    }
                });

                if (!allGraded) return;

                const mcqScore = originalResult.mcqScore;
                const totalTestPoints = test.questions.reduce((sum, q) => sum + (q.points || 1), 0);
                const finalScore = mcqScore + totalEssayScore;

                const finalResult = {
                    ...originalResult,
                    score: `${finalScore} / ${totalTestPoints}`,
                    status: 'graded',
                    answers: updatedAnswers
                };

                try {
                    const updates = {};
                    updates[`results/${currentUser}/${testId}/${studentName}`] = finalResult;
                    updates[`studentResults/${studentName}/${testId}`] = finalResult;
                    await update(ref(db), updates);

                    showCustomAlert("نجاح", "تم حفظ الدرجات بنجاح.");
                    reviewModal.classList.remove('visible');
                    loadStudentResultsForTest(testId); // Refresh the list
                } catch (error) {
                    console.error("Finalize Grades Error:", error);
                    showCustomAlert("خطأ", "حدث خطأ أثناء حفظ الدرجات.");
                }
            }


            reviewModal.querySelector('.modal-close-btn').onclick = () => reviewModal.classList.remove('visible');

            const populateResultsSelector = () => { resultsTestSelector.innerHTML = '<option value="">اختر اختبارًا</option>'; Object.entries(myTests).forEach(([testId, test]) => resultsTestSelector.innerHTML += `<option value="${testId}">${test.name}</option>`); };
            const handleImagePreview = (input, container, previewImg, storage) => { const f=input.files[0]; if(f) getBase64(f).then(d=>{ if(storage==='q') currentQuestionImageBase64=d; else currentModelAnswerImageBase64=d; previewImg.src=d; container.classList.remove('hidden'); }) };
            questionImageInput.onchange = () => handleImagePreview(questionImageInput, questionImageInput.nextElementSibling, questionImageInput.nextElementSibling.querySelector('img'), 'q');
            modelAnswerImageInput.onchange = () => handleImagePreview(modelAnswerImageInput, modelAnswerImageInput.nextElementSibling, modelAnswerImageInput.nextElementSibling.querySelector('img'), 'm');

            const renderQuestionsList = () => {
                questionsListContainer.innerHTML = questionsArray.length > 0 ? "<h3>الأسئلة المضافة:</h3>" : "";
                questionsArray.forEach((q, i) => {
                    const d=document.createElement('div');
                    d.className='list-item';
                    d.innerHTML=`<span style="flex-grow:1; text-align:right;">${i+1}. [${q.type==='mcq'?'اختياري':'مقالي'}] ${q.question ? q.question.substring(0,30) : 'سؤال بصورة'}... (${q.points} درجات)</span>
                    <div style="display:flex; gap: 5px;">
                        <button data-index="${i}" class="action-btn btn-secondary edit-q-btn" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button data-index="${i}" class="action-btn btn-secondary delete-q-btn" title="حذف" style="background:#dc3545; border-color:#c82333;"><i class="fas fa-trash"></i></button>
                    </div>`;
                    questionsListContainer.appendChild(d);
                });
                questionsListContainer.querySelectorAll('.delete-q-btn').forEach(btn => btn.onclick = e => { questionsArray.splice(parseInt(btn.dataset.index),1); renderQuestionsList(); });
                questionsListContainer.querySelectorAll('.edit-q-btn').forEach(btn => btn.onclick = e => startEditingQuestion(parseInt(btn.dataset.index)));
            };

            const startEditingQuestion = (index) => {
                const q = questionsArray[index];
                if (!q) return;
                currentEditingQuestionIndex = index;
                questionText.value = q.question;
                questionPointsInput.value = q.points;
                //... populate other fields based on q.type
                addQuestionBtn.textContent = "تحديث السؤال";
                cancelQuestionEditBtn.classList.remove('hidden');
            };
            cancelQuestionEditBtn.onclick = clearQuestionForm;


            addQuestionBtn.onclick = () => {
                const q = questionText.value.trim();
                const points = parseInt(questionPointsInput.value) || 1;
                if (!q && !currentQuestionImageBase64) { showCustomAlert("خطأ", "يرجى كتابة نص السؤال أو إرفاق صورة له على الأقل."); return; }
                let questionData = { question: q, type: currentQuestionType, image: currentQuestionImageBase64, points: points };
                if (currentQuestionType === 'mcq') {
                    const opts = Array.from(optionInputs).map(i => i.value.trim());
                    const correct = parseInt(correctAnswerInput.value);
                    if (opts.some(o => o === "") || !correct || opts.length !== 4 || correct < 1 || correct > 4) { showCustomAlert("خطأ", "يرجى ملء الخيارات الأربعة وتحديد الإجابة الصحيحة (1-4)."); return; }
                    questionData = { ...questionData, options: opts, correct };
                } else { questionData.modelAnswerImage = currentModelAnswerImageBase64; }

                if (currentEditingQuestionIndex > -1) {
                    questionsArray[currentEditingQuestionIndex] = questionData;
                } else {
                    questionsArray.push(questionData);
                }
                renderQuestionsList();
                clearQuestionForm();
            };

            saveTestBtn.onclick = async (e) => {
                const button = e.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = "جاري الحفظ...";

                const n=testNameInput.value.trim(),g=testGradeSelect.value,d=testDurationInput.value.trim(),p=preventGoBackCheckbox.checked, s=shuffleQuestionsCheckbox.checked;
                if(!n||!g||!d||questionsArray.length===0){
                    showCustomAlert("خطأ", "يرجى ملء تفاصيل الاختبار وإضافة سؤال واحد على الأقل.");
                    button.disabled = false; button.textContent = originalText;
                    return;
                }
                const testData = { name:n, grade:g, duration:parseInt(d), preventGoBack:p, shuffle: s, questions:questionsArray, timestamp:Date.now() };
                
                try {
                    if (currentEditingTestId) {
                        await set(ref(db, `tests/${currentUser}/${currentEditingTestId}`), testData);
                        showCustomAlert("نجاح", "تم تحديث الاختبار بنجاح!");
                    } else {
                        await push(ref(db, `tests/${currentUser}`), testData);
                        showCustomAlert("نجاح", "تم حفظ الاختبار بنجاح!");
                    }
                    resetCreateFormState();
                    setDefaultTab();
                } catch(error) {
                    console.error("Save/Update Error:", error);
                    showCustomAlert("خطأ", "حدث خطأ أثناء الحفظ.");
                } finally {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            };
            
            async function authUser(name, password, isRegister) { 
                if (!name || !password) { showCustomAlert("خطأ", "الرجاء تعبئة كل الحقول"); return; }
                if (!/^[a-zA-Z0-9\s]+$/.test(name)) {
                    showCustomAlert("خطأ", "الرجاء استخدام الحروف والأرقام الإنجليزية فقط في الاسم.");
                    return;
                }
                const userRef = ref(db, `users/${name}`); 
                const snapshot = await get(userRef); 
                if (isRegister) { 
                    if (snapshot.exists()) { showCustomAlert("خطأ", "اسم المستخدم هذا موجود بالفعل."); return; }
                    await set(userRef, { password }); 
                    // Auto-login
                    currentUser = name;
                    localStorage.setItem("loggedInTeacher", currentUser);
                    showSection(dashboardSection);
                    updateDashboard();
                } else { 
                    if (!snapshot.exists() || snapshot.val().password !== password) { showCustomAlert("خطأ", "اسم المستخدم أو كلمة المرور غير صحيحة."); return; }
                    currentUser = name; 
                    localStorage.setItem("loggedInTeacher", currentUser); 
                    showSection(dashboardSection); 
                    updateDashboard(); 
                } 
            }
            
            teacherPortal.querySelector('#teacher-login-btn').onclick = () => authUser(teacherPortal.querySelector("#teacher-login-name").value.trim(), teacherPortal.querySelector("#teacher-login-password").value.trim(), false);
            teacherPortal.querySelector('#teacher-register-btn').onclick = () => authUser(teacherPortal.querySelector("#teacher-register-name").value.trim(), teacherPortal.querySelector("#teacher-register-password").value.trim(), true);
            logoutIcon.onclick = async () => { 
                const confirmed = await showCustomConfirm("تأكيد", "هل أنت متأكد من رغبتك في تسجيل الخروج؟");
                if (confirmed) { 
                    currentUser=null; 
                    localStorage.removeItem("loggedInTeacher");
                    // Go to landing page instead of login
                    teacherPortal.classList.add('hidden');
                    mainLandingPage.classList.remove('hidden');
                } 
            };
            resultsTestSelector.onchange = (e) => loadStudentResultsForTest(e.target.value);
            teacherPortal.querySelectorAll('.to-login').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(loginSection)});
            teacherPortal.querySelectorAll('.to-register').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(registerSection)});

            // Profile Modal Logic
            profileIcon.onclick = () => {
                updateNameInput.value = currentUser;
                updatePasswordInput.value = '';
                profileModal.classList.add('visible');
            };
            profileModal.querySelector('.modal-close-btn').onclick = () => profileModal.classList.remove('visible');
            updateBtn.onclick = async () => {
                const newName = updateNameInput.value.trim();
                const newPassword = updatePasswordInput.value.trim();
                
                if (!newName) { showCustomAlert("خطأ", "لا يمكن أن يكون الاسم فارغًا."); return; }
                if (!/^[a-zA-Z0-9\s]+$/.test(newName)) { showCustomAlert("خطأ", "الرجاء استخدام الحروف والأرقام الإنجليزية فقط في الاسم."); return; }
                if (newName === currentUser && !newPassword) { profileModal.classList.remove('visible'); return; }

                try {
                    const updates = {};
                    if(newPassword) updates.password = newPassword;

                    if (newName !== currentUser) {
                        const oldUserRef = ref(db, `users/${currentUser}`);
                        const oldDataSnap = await get(oldUserRef);
                        const oldData = oldDataSnap.val();
                        
                        const newNameSnap = await get(ref(db, `users/${newName}`));
                        if (newNameSnap.exists()) {
                            showCustomAlert("خطأ", "هذا الاسم مستخدم بالفعل. الرجاء اختيار اسم آخر.");
                            return;
                        }

                        const dataToMove = { [`users/${newName}`]: { ...oldData, ...updates }, [`users/${currentUser}`]: null };
                        const pathsToMove = ['tests', 'results'];
                        for (const path of pathsToMove) {
                            const oldPathRef = ref(db, `${path}/${currentUser}`);
                            const pathSnap = await get(oldPathRef);
                            if (pathSnap.exists()) {
                                dataToMove[`${path}/${newName}`] = pathSnap.val();
                                dataToMove[`${path}/${currentUser}`] = null;
                            }
                        }
                        
                        await update(ref(db), dataToMove);
                        localStorage.setItem('loggedInTeacher', newName); 
                        showCustomAlert("نجاح", "تم تحديث الحساب بنجاح! سيتم إعادة تحميل الصفحة.");
                        setTimeout(() => window.location.reload(), 1500);

                    } else { // Only password changed
                        await update(ref(db, `users/${currentUser}`), updates);
                        showCustomAlert("نجاح", "تم تحديث كلمة المرور بنجاح!");
                        profileModal.classList.remove('visible');
                    }

                } catch (error) {
                    console.error("Update Error:", error);
                    showCustomAlert("خطأ", "حدث خطأ أثناء تحديث الحساب.");
                }
            };
        }

        function initStudentApp() {
            const allSections=studentPortal.querySelectorAll('section');const[registerSection,loginSection,dashboard,takeTest,result,review]=allSections;const nameSpan=studentPortal.querySelector('#student-name');const logoutIcon=studentPortal.querySelector('#student-logout-icon');const profileIcon=studentPortal.querySelector('#student-profile-icon');const testsContainer=studentPortal.querySelector('#available-tests-container');const resultsContainer=studentPortal.querySelector('#my-student-results-container');const searchBar=studentPortal.querySelector('#search-bar');const timerDisplay=studentPortal.querySelector('#timer');const timerProgress=studentPortal.querySelector('#timer-progress');const testTitle=studentPortal.querySelector('#current-test-title');const questionsDisplay=studentPortal.querySelector('#questions-display');const finalScore=studentPortal.querySelector('#final-score');const feedbackMsg=studentPortal.querySelector('#feedback-message');const bottomNav=studentPortal.querySelector('#student-bottom-nav');const qNavContainer=studentPortal.querySelector('#question-navigation-container');const[prevQBtn,nextQBtn]=[studentPortal.querySelector('#prev-question-btn'),studentPortal.querySelector('#next-question-btn')];const submitBtn=studentPortal.querySelector('#submit-test-btn');const reviewContainer=studentPortal.querySelector('#review-container');
            const profileModal = studentPortal.querySelector('#student-profile-modal');
            const updateNameInput = studentPortal.querySelector('#student-update-name');
            const updatePasswordInput = studentPortal.querySelector('#student-update-password');
            const updateBtn = studentPortal.querySelector('#student-update-btn');
            
            let currentStudent=null,takenTests={},allTests={},currentTest=null,testInterval=null,totalSec=0,remainSec=0,answers=[],qIndex=0,lastAnswers=[];
            
            const showSection=s=>{allSections.forEach(e=>e.classList.add('hidden'));s.classList.remove('hidden');bottomNav.classList.toggle('hidden',s.id!=='student-dashboard-section')};
            const showLoading=c=>{c.innerHTML='<div class="spinner"></div>'};
            
            async function loadDashboard(){if(!currentStudent)return;nameSpan.textContent=currentStudent;logoutIcon.classList.remove('hidden');profileIcon.classList.remove('hidden');setDefaultTab();showLoading(testsContainer);showLoading(resultsContainer);const resultsSnap=await get(ref(db,`studentResults/${currentStudent}`));takenTests=resultsSnap.exists()?resultsSnap.val():{};renderStudentResults();const testsRef=ref(db,'tests');onValue(testsRef,snap=>{allTests=snap.exists()?snap.val():{};renderAvailableTests()},{onlyOnce:true})}
            
            function renderAvailableTests(filter=''){testsContainer.innerHTML='';let found=false;Object.entries(allTests).forEach(([teacherId,teacherTests])=>{Object.entries(teacherTests).forEach(([testId,test])=>{const isExpired=Date.now()-test.timestamp>48*60*60*1000;if(isExpired&&!takenTests[testId])return;const searchStr=`${test.name}${test.grade}${teacherId}`.toLowerCase();if(filter&&!searchStr.includes(filter.toLowerCase()))return;found=true;const completed=!!takenTests[testId];const buttonText=completed?'مراجعة / إعادة المحاولة':'ابدأ';const card=document.createElement('div');card.className='list-item';card.style.flexDirection='column';card.style.alignItems='stretch';card.innerHTML=`<div style="display:flex; justify-content:space-between; align-items:flex-start; width:100%; margin-bottom:15px;"><div style="text-align:right;"><strong>${test.name}</strong><br><small style="color: #dc3545; font-weight:bold; cursor: pointer;" data-teacher-id="${teacherId}">${teacherId}<i class="fas fa-comment-dots" style="margin-right: 8px; color: #00aaff; cursor: pointer;"></i></small></div><button class="action-btn btn-secondary" data-action="share" title="مشاركة" style="font-size: 1rem !important;"><i class="fas fa-share-alt"></i></button></div><div style="display:flex; gap:10px;"><button class="btn-3d" data-action="start" style="flex:1; padding: 10px; font-size:1.1rem; border-bottom-width:4px;">${buttonText}</button><button class="btn-3d" data-action="copy" style="flex:1; padding: 10px; font-size:1.1rem; background: #6c757d; border-bottom:4px solid #5a6268;">نسخ الرابط</button></div>`;card.querySelector('[data-action="start"]').onclick=()=>startTest(teacherId,testId,test);card.querySelector('[data-action="copy"]').onclick=()=>copyTestLink(teacherId,testId);card.querySelector('[data-action="share"]').onclick=()=>copyTestLink(teacherId,testId);testsContainer.appendChild(card)})});if(!found)testsContainer.innerHTML='<p>لا توجد اختبارات متاحة حاليًا.</p>'}
            function renderStudentResults(){resultsContainer.innerHTML='';const results=Object.values(takenTests).sort((a,b)=>b.timestamp-a.timestamp);if(results.length===0){resultsContainer.innerHTML='<p>لم تقم بإجراء أي اختبار بعد.</p>';return}results.forEach(r=>{const d=new Date(r.timestamp).toLocaleString('ar-EG');const isPending = r.status === 'pending';const pendingIndicator = isPending ? `<span style="color:#ffc107; font-weight:bold; font-size: 0.8rem;">(قيد المراجعة)</span>` : '';const div=document.createElement('div');div.className='test-item';div.innerHTML=`<div style="text-align:right; flex-grow:1;"><strong>${r.testName}</strong><br><small>الدرجة: <strong>${r.score}</strong> ${pendingIndicator}</small></div><small>${d}</small>`;resultsContainer.appendChild(div)})}
            
            function startTest(teacherId,testId,testData){
                currentTest={...testData,id:testId,teacherId};
                if(currentTest.shuffle) currentTest.questions.sort(() => Math.random() - 0.5); // Shuffle questions
                testTitle.textContent=currentTest.name;totalSec=currentTest.duration*60;remainSec=totalSec;answers=new Array(currentTest.questions.length).fill(null);qIndex=0;timerDisplay.textContent=formatTime(remainSec);timerProgress.style.width='100%';if(testInterval)clearInterval(testInterval);testInterval=setInterval(()=>{remainSec--;timerDisplay.textContent=formatTime(remainSec);timerProgress.style.width=((remainSec/totalSec)*100)+'%';if(remainSec<=0){clearInterval(testInterval);submitTest(true)}},1000);if(currentTest.preventGoBack){submitBtn.classList.add('hidden');qNavContainer.classList.remove('hidden');renderQuestion(qIndex)}else{submitBtn.classList.remove('hidden');qNavContainer.classList.add('hidden');renderAllQuestions()}showSection(takeTest)
            }
            
            function reviewTest(testId) {
                const result = takenTests[testId];
                if (!result) return;
                currentTest = {name: result.testName, questions: allTests[result.teacherName][testId].questions};
                lastAnswers = result.answers;
                finalScore.textContent = `درجتك: ${result.score}`;
                feedbackMsg.style.background = '#333';
                feedbackMsg.style.color = '#fff';
                feedbackMsg.textContent = "هذه مراجعة لنتيجتك السابقة.";
                if (result.status === 'pending') {
                    feedbackMsg.style.background = '#ffc107';
                    feedbackMsg.style.color = '#111';
                    feedbackMsg.textContent = "نتيجتك النهائية لا تزال قيد المراجعة من قبل المعلم.";
                }
                showSection(result);
            }

            function renderAllQuestions(){questionsDisplay.innerHTML='';currentTest.questions?.forEach((q,idx)=>{const qDiv=document.createElement('div');qDiv.style.marginBottom='25px';let ansHtml='';if(q.type==='mcq'){ansHtml=`<div class="question-options">${q.options.map((o,i)=>`<label><input type="radio" name="question-${idx}" value="${i+1}" onchange="saveAnswer(${idx},this.value,'mcq')"/><span>${o}</span></label>`).join('')}</div>`}else{ansHtml=`<div><label>إجابتك:</label><textarea id="text-answer-${idx}" oninput="saveAnswer(${idx}, this.value, 'essay-text')"></textarea><label for="image-answer-${idx}" class="file-input-label"><i class="fas fa-upload"></i> رفع صورة</label><input type="file" id="image-answer-${idx}" accept="image/*" class="hidden" onchange="handleEssayImageUpload(${idx}, this)"></div>`}qDiv.innerHTML=`<h4 style="text-align:right;margin-bottom:15px;">س ${idx+1}: ${q.question}</h4>${q.image?`<img src="${q.image}" style="max-width:100%;border-radius:10px;margin:10px 0; cursor:pointer;">`:''}${ansHtml}`;questionsDisplay.appendChild(qDiv)})}
            function renderQuestion(index){const q=currentTest.questions[index];let ansHtml='';const saved=answers[index];if(q.type==='mcq'){ansHtml=`<div class="question-options">${q.options.map((o,i)=>{const checked=saved&&saved.answer===(i+1)?'checked':'';return`<label><input type="radio" name="question-${index}" value="${i+1}" ${checked}/><span>${o}</span></label>`}).join('')}</div>`}else{const text=saved&&saved.textAnswer?saved.textAnswer:'';const uploaded=saved&&saved.imageAnswer;ansHtml=`<div><label>إجابتك:</label><textarea id="text-answer-${index}">${text}</textarea><label for="image-answer-${index}" class="file-input-label"><i class="fas ${uploaded?'fa-check-circle':'fa-upload'}"></i> ${uploaded?'تغيير الصورة':'رفع صورة'}</label><input type="file" id="image-answer-${index}" accept="image/*" class="hidden"></div>`}questionsDisplay.innerHTML=`<h4 style="margin-bottom:15px;">س ${index+1}/${currentTest.questions.length}: ${q.question}</h4>${q.image?`<img src="${q.image}" style="max-width:100%;border-radius:10px;margin:10px 0; cursor:pointer;">`:''}${ansHtml}`;if(q.type==='essay'){document.getElementById(`image-answer-${index}`).onchange=()=>handleEssayImageUpload(index,document.getElementById(`image-answer-${index}`))}prevQBtn.disabled=index===0;nextQBtn.classList.toggle('hidden',index===currentTest.questions.length-1);submitBtn.classList.toggle('hidden',index!==currentTest.questions.length-1)}
            
            window.saveAnswer=(idx,val,type)=>{if(type==='mcq'){answers[idx]={type:'mcq',answer:parseInt(val)}}else if(type==='essay-text'){if(!answers[idx])answers[idx]={type:'essay'};answers[idx].textAnswer=val}};
            window.handleEssayImageUpload=async(idx,input)=>{const file=input.files[0];if(file){const b64=await getBase64(file);if(!answers[idx])answers[idx]={type:'essay'};answers[idx].imageAnswer=b64;input.previousElementSibling.innerHTML=`<i class="fas fa-check-circle"></i> تم الرفع!`}};
            
            function saveCurrentAnswer(){const q=currentTest.questions[qIndex];if(q.type==='mcq'){const checked=questionsDisplay.querySelector(`input[name="question-${qIndex}"]:checked`);if(checked)answers[qIndex]={type:'mcq',answer:parseInt(checked.value)}}else{const text=questionsDisplay.querySelector(`#text-answer-${qIndex}`).value;if(text.trim()!==''||(answers[qIndex]&&answers[qIndex].imageAnswer)){if(!answers[qIndex])answers[qIndex]={type:'essay'};answers[qIndex].textAnswer=text}}}
            nextQBtn.onclick=()=>{if(qIndex<currentTest.questions.length-1){saveCurrentAnswer();qIndex++;renderQuestion(qIndex)}};
            prevQBtn.onclick=()=>{if(qIndex>0){saveCurrentAnswer();qIndex--;renderQuestion(qIndex)}};
            
            async function submitTest(timeUp=false){
                clearInterval(testInterval);
                if(timeUp) showCustomAlert('انتهى الوقت!','تم تسليم إجاباتك الحالية.');
                if(currentTest.preventGoBack) saveCurrentAnswer();
                
                let mcqScore = 0;
                let mcqTotalPoints = 0;
                const hasEssays = currentTest.questions.some(q => q.type === 'essay');
                const totalTestPoints = currentTest.questions.reduce((sum, q) => sum + (q.points || 1), 0);

                currentTest.questions.forEach((q, idx) => {
                    if (q.type === 'mcq') {
                        mcqTotalPoints += (q.points || 1);
                        if (answers[idx] && answers[idx].answer === q.correct) {
                            mcqScore += (q.points || 1);
                        }
                    }
                });

                const resultObj = {
                    testName: currentTest.name,
                    teacherName: currentTest.teacherId,
                    timestamp: serverTimestamp(),
                    answers: answers,
                    mcqScore: mcqScore,
                    totalPoints: totalTestPoints,
                    status: hasEssays ? 'pending' : 'graded',
                    score: hasEssays ? `${mcqScore} / ${mcqTotalPoints}` : `${mcqScore} / ${totalTestPoints}`
                };
                
                // Only save the result if it's the first attempt
                if (!takenTests[currentTest.id]) {
                    await set(ref(db, `studentResults/${currentStudent}/${currentTest.id}`), resultObj);
                    await set(ref(db, `results/${currentTest.teacherId}/${currentTest.id}/${currentStudent}`), resultObj);
                    takenTests[currentTest.id] = resultObj;
                }
                
                lastAnswers = [...answers];
                finalScore.textContent = `درجتك: ${resultObj.score}`;

                if (hasEssays) {
                    feedbackMsg.style.background = '#ffc107';
                    feedbackMsg.style.color = '#111';
                    feedbackMsg.textContent = "تم إرسال إجاباتك المقالية للمراجعة! هذه نتيجتك المبدئية للأسئلة الاختيارية.";
                } else {
                    const percent = totalTestPoints > 0 ? Math.round((mcqScore / totalTestPoints) * 100) : 0;
                    const fb = percent === 100 ? { t: '🥳 ممتاز!', c: '#28a745' } : percent >= 80 ? { t: '😊 عمل رائع!', c: '#28a745' } : percent >= 50 ? { t: '🙂 جيد!', c: '#ffc107', tc: '#111' } : { t: '🙁 حاول مجددًا!', c: '#dc3545' };
                    feedbackMsg.style.background = fb.c;
                    feedbackMsg.style.color = fb.tc || '#fff';
                    feedbackMsg.textContent = fb.t;
                }
                showSection(result);
            }
            submitBtn.onclick=()=>submitTest(false);

            function showReview(){reviewContainer.innerHTML='';currentTest.questions.forEach((q,i)=>{const ans=lastAnswers[i]||{};let html='';if(q.type==='mcq'){const correct=ans.answer===q.correct;html=`<div style="background:${correct?'rgba(63,185,80,0.1)':'rgba(248,81,73,0.1)'};padding:10px;border-radius:8px;"><b>إجابتك:</b> ${ans.answer?q.options[ans.answer-1]:'<i>لم تجب</i>'}<br><b>الصحيحة:</b> ${q.options[q.correct-1]}</div>`}else{const txt=ans.textAnswer||'<em>لم تجب نصيًا.</em>';const img=ans.imageAnswer?`<p><b>صورتك:</b></p><img src="${ans.imageAnswer}" style="max-width:80%;border-radius:8px; cursor:pointer;">`:'';const model=q.modelAnswerImage?`<p><b>النموذجية:</b></p><img src="${q.modelAnswerImage}" style="max-width:80%;border-radius:8px; cursor:pointer;">`:'';html=`<div><p><b>إجابتك النصية:</b></p><div style="background:#222;padding:10px;border-radius:8px;">${txt}</div>${img}${model}</div>`}const qDiv=document.createElement('div');qDiv.className='list-item';qDiv.style.flexDirection='column'; qDiv.style.alignItems='flex-start'; qDiv.innerHTML=`<h4 style="margin-bottom:10px;">س ${i+1}: ${q.question}</h4>${q.image ? `<img src="${q.image}" style="max-width:100%;border-radius:10px;margin:10px 0; cursor:pointer;">` : ''}${html}`;reviewContainer.appendChild(qDiv)});showSection(review)}
            
            async function authUser(name,pass,isRegister){
                if(!name||!pass) { showCustomAlert('خطأ','الرجاء ملء جميع الحقول'); return; }
                if (!/^[a-zA-Z0-9\s]+$/.test(name)) { showCustomAlert("خطأ", "الرجاء استخدام الحروف والأرقام الإنجليزية فقط في الاسم."); return; }
                const userRef=ref(db,`students/${name}`);
                const snap=await get(userRef);
                if(isRegister){
                    if(snap.exists()) { showCustomAlert('خطأ','اسم المستخدم موجود.'); return; }
                    await set(userRef,{password:pass});
                    // Auto-login
                    currentStudent = name;
                    localStorage.setItem('loggedInStudent', currentStudent);
                    showSection(dashboard);
                    loadDashboard();
                } else {
                    if(!snap.exists()||snap.val().password!==pass) { showCustomAlert('خطأ','بيانات الدخول غير صحيحة.'); return; }
                    currentStudent=name;
                    localStorage.setItem('loggedInStudent',currentStudent);
                    const deepLink=sessionStorage.getItem('deepLinkTest');
                    if(deepLink){await startDeepLinkTest()}else{showSection(dashboard);loadDashboard()}
                }
            }

            async function startDeepLinkTest(){const dataJSON=sessionStorage.getItem('deepLinkTest');if(!dataJSON)return;const{teacherId,testId}=JSON.parse(dataJSON);sessionStorage.removeItem('deepLinkTest');const testRef=ref(db,`tests/${teacherId}/${testId}`);const testSnap=await get(testRef);if(testSnap.exists()){startTest(teacherId,testId,testSnap.val())}else{showCustomAlert('خطأ','الاختبار غير موجود.');showSection(dashboard);loadDashboard()}}
            const formatTime=s=>{const m=Math.floor(s/60);const r=s%60;return`${m.toString().padStart(2,'0')}:${r.toString().padStart(2,'0')}`};
            
            const navButtons=studentPortal.querySelectorAll('.nav-btn');navButtons.forEach(b=>{b.addEventListener('click',()=>{navButtons.forEach(btn=>btn.classList.remove('active'));studentPortal.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));b.classList.add('active');studentPortal.querySelector(`#${b.dataset.target}`).classList.remove('hidden')})});
            const setDefaultTab=()=>navButtons[0].click();
            studentPortal.querySelector('#student-register-btn').onclick=()=>authUser(studentPortal.querySelector('#student-register-name').value.trim(),studentPortal.querySelector('#student-register-password').value.trim(),true);
            studentPortal.querySelector('#student-login-btn').onclick=()=>authUser(studentPortal.querySelector('#student-login-name').value.trim(),studentPortal.querySelector('#student-login-password').value.trim(),false);
            studentPortal.querySelectorAll('.to-login').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(loginSection)});
            studentPortal.querySelectorAll('.to-register').forEach(el=>el.onclick=e=>{e.preventDefault();showSection(registerSection)});
            studentPortal.querySelector('#back-to-dashboard-btn').onclick=()=>{showSection(dashboard);loadDashboard()};
            studentPortal.querySelector('#cancel-test-btn').onclick= async ()=>{
                const confirmed = await showCustomConfirm('تأكيد', 'هل أنت متأكد من إلغاء الاختبار؟ لن يتم حفظ تقدمك.');
                if(confirmed){
                    clearInterval(testInterval);
                    showSection(dashboard);
                    loadDashboard();
                }
            };
            studentPortal.querySelector('#review-answers-btn').onclick=showReview;
            studentPortal.querySelector('#back-to-results-btn').onclick=()=>showSection(result);
            searchBar.addEventListener('input',e=>renderAvailableTests(e.target.value));
            logoutIcon.onclick= async ()=>{
                const confirmed = await showCustomConfirm('تأكيد', 'هل أنت متأكد من رغبتك في تسجيل الخروج؟');
                if(confirmed){
                    currentStudent=null;
                    localStorage.removeItem('loggedInStudent');
                    studentPortal.classList.add('hidden');
                    mainLandingPage.classList.remove('hidden');
                }
            };
            
            // Student Profile Modal Logic
            profileIcon.onclick = () => {
                updateNameInput.value = currentStudent;
                updatePasswordInput.value = '';
                profileModal.classList.add('visible');
            };
            profileModal.querySelector('.modal-close-btn').onclick = () => profileModal.classList.remove('visible');
            updateBtn.onclick = async () => {
                const newName = updateNameInput.value.trim();
                const newPassword = updatePasswordInput.value.trim();
                
                if (!newName) { showCustomAlert("خطأ", "لا يمكن أن يكون الاسم فارغًا."); return; }
                if (!/^[a-zA-Z0-9\s]+$/.test(newName)) { showCustomAlert("خطأ", "الرجاء استخدام الحروف والأرقام الإنجليزية فقط في الاسم."); return; }
                if (newName === currentStudent && !newPassword) { profileModal.classList.remove('visible'); return; }
                
                try {
                    const updates = {};
                    if(newPassword) updates.password = newPassword;

                    if (newName !== currentStudent) {
                         const oldUserRef = ref(db, `students/${currentStudent}`);
                        const oldDataSnap = await get(oldUserRef);
                        const oldData = oldDataSnap.val();

                        const newNameSnap = await get(ref(db, `students/${newName}`));
                        if (newNameSnap.exists()) {
                            showCustomAlert("خطأ", "هذا الاسم مستخدم بالفعل. الرجاء اختيار اسم آخر.");
                            return;
                        }

                        const dataToMove = { [`students/${newName}`]: { ...oldData, ...updates }, [`students/${currentStudent}`]: null };
                        const resultsSnap = await get(ref(db, `studentResults/${currentStudent}`));
                        if(resultsSnap.exists()){
                            dataToMove[`studentResults/${newName}`] = resultsSnap.val();
                            dataToMove[`studentResults/${currentStudent}`] = null;
                        }
                        
                        await update(ref(db), dataToMove);
                        localStorage.setItem('loggedInStudent', newName); 
                        showCustomAlert("نجاح", "تم تحديث الحساب بنجاح! سيتم إعادة تحميل الصفحة.");
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                         await update(ref(db, `students/${currentStudent}`), updates);
                        showCustomAlert("نجاح", "تم تحديث كلمة المرور بنجاح!");
                        profileModal.classList.remove('visible');
                    }
                } catch (error) {
                    console.error("Update Error:", error);
                    showCustomAlert("خطأ", "حدث خطأ أثناء تحديث الحساب.");
                }
            };
        }

        function copyTestLink(teacherId, testId) {
            const link = `${window.location.origin}${window.location.pathname}#test/${encodeURIComponent(teacherId)}/${encodeURIComponent(testId)}`;
            navigator.clipboard.writeText(link).then(() => {
                showCustomAlert('تم النسخ', 'تم نسخ رابط الاختبار بنجاح!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        }
        
        // --- Global Image Viewer Logic ---
        const imageViewerModal = document.getElementById('image-viewer-modal');
        const modalImage = imageViewerModal.querySelector('.image-modal-content');
        const modalDownloadBtn = imageViewerModal.querySelector('.image-modal-download-btn');
        
        function openImageViewer(src) {
            if (!src || src.endsWith('#') || !src.startsWith('data:image')) return;
            modalImage.src = src;
            modalDownloadBtn.href = src;
            imageViewerModal.classList.add('visible');
        }

        function closeImageViewer() {
            imageViewerModal.classList.remove('visible');
            setTimeout(() => { modalImage.src = ''; }, 300); // Clear src after transition
        }

        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG' && e.target.closest('.portal-container, .modal-content')) {
                if (e.target.src && e.target.src.startsWith('data:image')) {
                    e.preventDefault(); 
                    openImageViewer(e.target.src);
                }
            }
        });

        imageViewerModal.querySelector('.modal-close-btn').addEventListener('click', closeImageViewer);
        imageViewerModal.addEventListener('click', (e) => {
            if (e.target === imageViewerModal) { 
                closeImageViewer();
            }
        });
        
        // --- Global Chat Logic ---
        // Will be implemented later if needed

        // --- Initial App Load Logic ---
        const savedTeacher = localStorage.getItem('loggedInTeacher');
        const savedStudent = localStorage.getItem('loggedInStudent');

        if (savedTeacher) {
            mainLandingPage.classList.add('hidden');
            teacherPortal.classList.remove('hidden');
            initTeacherApp();
        } else if (savedStudent) {
            mainLandingPage.classList.add('hidden');
            studentPortal.classList.remove('hidden');
            initStudentApp();
        } else if (!handleDeepLink()) {
            mainLandingPage.classList.remove('hidden');
        }
    </script>
</body>
</html>
